<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Yeni Üretim Oluştur</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="sidebar">
        <h2><a href="{{ url_for('home') }}" style="text-decoration: none; color: white;">ERP Menüsü</a></h2>
        <ul>
            <ul>
                <li><a href="{{ url_for('musteriler') }}"><i class="fas fa-users"></i> Müşteri Yönetimi</a></li>
                <li><a href="{{ url_for('talepler') }}"><i class="fas fa-tasks"></i> Talep Yönetimi</a></li>
                <li><a href="{{ url_for('teklifler') }}"><i class="fas fa-file-invoice-dollar"></i> Teklif Yönetimi</a></li>
                <!-- <li><a href="{{ url_for('siparisler') }}"><i class="fas fa-shopping-cart"></i> Sipariş Yönetimi</a></li>-->
                <li><a href="{{ url_for('uretim') }}"><i class="fas fa-industry"></i> Üretim Yönetimi</a></li>
                <!-- <li><a href="{{ url_for('raporlar') }}"><i class="fas fa-chart-line"></i> Raporlama</a></li>-->
            </ul>
        
        </ul>
    <div class="logout">
        <a href="/logout"><i class="fas fa-sign-out-alt"></i> Çıkış Yap</a>
    </div>
    
    </div>
<div class="content">
    <div class="breadcrumb">
        <a href="/uretim"> Üretim </a> &gt; <span>Yeni İş Emri</span>
    </div>
    <div class="form-container">
        <form action="/uretim_olustur" method="POST">
            <div class="form-group">
                <label>İş Emri Numarası:</label>
                <input type="text" name="is_emri_no" value="{{ is_emri_no }}" readonly>
            </div>
            <div class="form-group">
                <label for="talep_id">Talep Numarası:</label>
                <select name="talep_id" id="talep_id" onchange="handleTalepChange()" required>
                    <option value="">Talep Seçiniz</option>
                    {% for talep in talepler %}
                        <option value="{{ talep.id }}" data-musteri="{{ talep.firma_unvani }}" data-talepno="{{ talep.musteri_no }}">{{ talep.musteri_no }} - {{ talep.firma_unvani }}</option>
                    {% endfor %}
                    <option value="manuel">Manuel Giriş</option>
                </select>
            </div>
            <div class="form-group">
                <label for="talep_no_input">Talep Numarası:</label>
                <input type="text" id="talep_no_input" name="manuel_musteri_no" readonly>
            </div>
            <div class="form-group">
                <label for="musteri_input">Müşteri:</label>
                <!-- Müşteri adı yazı olarak gösterilecek veya manuelse select açılacak -->
                <input type="text" id="musteri_input" name="musteri_adi" readonly>
                <select name="musteri_id" id="musteri_select" class="hidden">
                    <option value="">Müşteri seçiniz</option>
                    {% for musteri in musteriler %}
                        <option value="{{ musteri.id }}">{{ musteri.firma_unvani }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="ana_adet">Adet:</label>
                <input type="number" name="ana_adet" id="ana_adet" min="1" required>
            </div>
            <div class="form-group">
                <label>Açıklama:</label>
                <textarea name="aciklama" placeholder="Açıklama girin..."></textarea>
            </div>
            <hr>
            <h3>İş Emirleri</h3>
            <table class="modern-table" id="is_emri_tablosu">
                <thead>
                <tr>
                    <th>İş Emri No</th>
                    <th>Resim No</th>
                    <th>Adet</th>
                    <th>Tahmini Süre (saat)</th>
                    <th>Açıklama</th>
                    <th>Prosesler</th>
                </tr>
                </thead>
                <tbody id="is_emri_body"></tbody>
            </table>
            <div class="button-row">
                <button type="button" class="btn-outline" onclick="addIsEmri()"><i class="fas fa-plus"></i> İş Emri Ekle</button>
            </div>
            <div class="form-actions">
                <a href="/uretim" class="btn-cancel">Vazgeç</a>
                <button type="submit" class="btn-save">Kaydet</button>
            </div>
        </form>
    </div>
</div>
<div class="footer">
            <p>&copy; 2024 MANES Makine Mühendislik - Tüm hakları saklıdır.</p>
    </div>
<script>
    let isSayac = 0;
    const prosesler = ['İmalat', 'Kaynak', 'Taşlama', 'Temizlik', 'Klavuz', 'Kesim', 'Büküm', 'Boya', 'Kaplama'];

    function addIsEmri() {
        const tbody = document.getElementById('is_emri_body');
        const tr = document.createElement('tr');
        const checkboxlar = prosesler.map(p => `
            <label class="proses-item">
                <input type="checkbox" name="proses_${isSayac}[]" value="${p}"> ${p}
            </label>
        `).join('');
        const anaIsEmriNo = document.querySelector('[name=is_emri_no]').value;
        const isEmriNumarasi = isSayac === 0 ? anaIsEmriNo : `${anaIsEmriNo}-${isSayac}`;
        tr.innerHTML = `
            <td><input type="text" name="is_emri_no_list[]" value="${isEmriNumarasi}" readonly></td>
            <td><input type="text" name="resim_no_list[]"></td>
            <td><input type="number" name="adet_list[]" min="1"></td>
            <td><input type="number" name="sure_list[]" min="0" step="0.1" placeholder="saat"></td>
            <td><input type="text" name="aciklama_list[]"></td>
            <td><div class="prosesler-grid" data-alt-index="${isSayac}">${checkboxlar}</div></td>
            
        `;
        tbody.appendChild(tr);
        isSayac++;
    }

    function handleTalepChange() {
    const talepSelect = document.getElementById("talep_id");
    const musteriInput = document.getElementById("musteri_input");
    const musteriSelect = document.getElementById("musteri_select");
    const talepNoInput = document.getElementById("talep_no_input");

    const selectedOption = talepSelect.options[talepSelect.selectedIndex];

    if (talepSelect.value === "manuel") {
        // Manuel giriş
        musteriInput.classList.add('hidden');
        musteriSelect.classList.remove('hidden');
        musteriInput.value = '';
        talepNoInput.removeAttribute("readonly");
        talepNoInput.value = '';
    } else {
        // Seçilen talep üzerinden müşteri adı ve talep no çek
        musteriSelect.classList.add('hidden');
        musteriInput.classList.remove('hidden');
        musteriInput.value = selectedOption.getAttribute('data-musteri') || '';
        talepNoInput.setAttribute("readonly", true);
        talepNoInput.value = selectedOption.getAttribute('data-talepno') || '';
    }
}
    document.querySelector("form").addEventListener("submit", function (e) {
    e.preventDefault(); // Sayfanın yenilenmesini engelliyoruz

    const form = e.target;
    const formData = new FormData(form);

    fetch(form.action, {
        method: "POST",
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            Swal.fire({
                icon: "error",
                title: "Hata!",
                text: data.error,
                confirmButtonText: "Tamam"
            });
        } else {
            Swal.fire({
                title: "Başarılı!",
                text: data.message,
                icon: "success",
                confirmButtonText: "Tamam"
            }).then(() => {
                window.location.href = data.redirect; // Burada yönlendirme yapıyoruz
            });
        }
    })
    .catch(error => {
        Swal.fire({
            title: "Hata!",
            text: "Bir hata oluştu: " + error.message,
            icon: "error",
            confirmButtonText: "Tamam"
        });
    });
});

</script>
</body>
</html>
